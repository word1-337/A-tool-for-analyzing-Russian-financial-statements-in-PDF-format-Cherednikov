# Агент анализа финансовой устойчивости

Программный инструмент, предназначенный для автоматизированного анализа российской бухгалтерской финансовой отчётности (бухгалтерский баланс, отчёт о финансовых результатах, отчёт о движении денежных средств) в формате PDF. Система реализует следующие функциональные возможности:

- извлечение табличных данных из документов посредством библиотеки MinerU;
- вычисление ключевых коэффициентов финансовой устойчивости;
- оценка динамики показателей (темпы прироста по строкам отчётности);
- расчёт интегрального индекса финансовой устойчивости в диапазоне [0; 1];
- предоставление пользовательского веб-интерфейса на основе фреймворка Streamlit;
- формирование текстовых аналитических заключений посредством языковой модели Ollama (qwen2.5:32b) — функция является опциональной.

## Структура проекта

```
agent.py          — единый модуль: серверная логика (MinerU, вычисления) и веб-интерфейс
requirements.txt  — перечень зависимостей
results/          — директория для хранения сформированных отчётов в формате .txt (создаётся автоматически)
```

---

## Порядок установки

### Шаг 1 — Установка интерпретатора Python

Необходимо загрузить **Python версии 3.11** исключительно с официального ресурса [python.org](https://www.python.org/downloads/release/python-3119/), выбрав дистрибутив `Windows installer (64-bit)`.

> **Использование версии Python из Microsoft Store не допускается.** Данная версия осуществляет установку пакетов по пути длиной порядка 120 символов, что приводит к возникновению исключения `OSError` в процессе установки библиотеки MinerU ввиду значительной глубины её внутренней структуры каталогов.

В процессе установки необходимо активировать параметр **"Add Python to PATH"**.

Корректность установки следует проверить в новом терминале:
```
python --version
```
Ожидаемый результат: `Python 3.11.x`.

### Шаг 2 — Размещение проекта в директории с коротким путём

Репозиторий необходимо распаковать либо клонировать в **корневой каталог диска**, например:

```
C:\proj\
```

Итоговый путь к основному файлу должен иметь вид: `C:\proj\agent.py`.

> Размещение проекта по пути вида `C:\Users\...\Downloads\...` может повлечь аварийное завершение установки с ошибкой `OSError: No such file or directory` вследствие системного ограничения Windows на длину пути в 260 символов.

### Шаг 3 — Установка зависимостей

В терминале, открытом в директории `C:\proj\`, следует выполнить команду:

```
python -m pip install -r requirements.txt
```

Процесс установки предполагает загрузку пакетов суммарным объёмом порядка 2 ГБ.

### Шаг 4 — Запуск приложения

```
python -m streamlit run agent.py
```

После выполнения команды веб-интерфейс приложения станет доступен по адресу `http://localhost:8501`.

> При **первичной обработке PDF-документа** система MinerU автоматически осуществляет загрузку машинно-обучаемых моделей объёмом порядка 5 ГБ. Данная операция выполняется однократно и требует наличия подключения к сети Интернет, а также достаточного свободного дискового пространства.

---

## Настройка интеграции с Ollama (опционально)

Для активации функций «Краткий вывод ИИ» и «Спросить ИИ» необходимо выполнить следующие действия:

1. Установить Ollama: https://ollama.com/download
2. Загрузить языковую модель:
   ```
   ollama pull qwen2.5:32b
   ```

> Языковая модель `qwen2.5:32b` занимает порядка 20 ГБ дискового пространства и требует не менее 32 ГБ оперативной памяти для корректной работы.
> На вычислительных системах с ограниченными ресурсами рекомендуется использовать облегчённую версию `qwen2.5:7b`. Для этого в файле `agent.py` следует заменить все вхождения строки `model="qwen2.5:32b"` на `model="qwen2.5:7b"`.

---

## Устранение типовых ошибок установки

### `OSError: No such file or directory` в процессе выполнения `pip install`

**Причина:** дистрибутив Python из Microsoft Store производит установку пакетов по чрезмерно длинному системному пути, либо проект размещён в глубоко вложенной структуре каталогов.

**Решение 1 (рекомендуемое):** выполнить переустановку Python с [python.org](https://www.python.org/downloads/release/python-3119/) и разместить проект в директории `C:\proj\`.

**Решение 2 (при наличии прав администратора):** активировать поддержку длинных путей в реестре операционной системы:
```powershell
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -Value 1
```

---

### Команда `pip` не распознаётся / исполняемый файл `streamlit` не обнаружен

**Причина:** директория `Scripts` интерпретатора Python не включена в переменную окружения PATH (типичная проблема при использовании версии Microsoft Store).

**Решение:** следует использовать вызов через модульный интерфейс Python вместо прямого обращения к исполняемым файлам:
```
python -m pip install -r requirements.txt
python -m streamlit run agent.py
```

---

### `WARNING: ... is not on PATH`

Данное сообщение носит информационный характер и **не является ошибкой**. Процесс установки продолжается в штатном режиме. Для запуска приложения следует использовать команду `python -m streamlit`.

---

### `ModuleNotFoundError: No module named 'torch'`

Библиотека MinerU требует наличия PyTorch, однако в ряде случаев не производит его автоматическую установку.

```
python -m pip install torch torchvision
```

---

### `ModuleNotFoundError: No module named 'doclayout_yolo'` (или иной модуль MinerU)

При работе в режиме pipeline библиотека MinerU требует установки дополнительных компонентов. Необходимо выполнить установку с расширенными зависимостями:

```
python -m pip install "mineru[pipeline]"
```

---

### Аварийное завершение установки в промежуточной стадии

Менеджер пакетов pip сохраняет состояние прогресса установки. Для возобновления процесса достаточно повторно выполнить исходную команду:

```
python -m pip install -r requirements.txt
```

---

### Ошибки установки MinerU при использовании Python 3.12 / 3.13

Библиотека MinerU несовместима с версиями Python 3.12 и выше. Обязательным условием является использование **Python 3.11**.

---

### Продолжительный процесс загрузки моделей MinerU

Длительная загрузка при первом запуске (~5 ГБ) является штатным поведением системы. Не следует закрывать браузер до завершения операции.

---

### Отсутствие отклика от сервиса Ollama

Необходимо убедиться в активном состоянии сервиса:
```
ollama serve
```
При корректной установке Ollama запускается автоматически. В случае отсутствия отклика рекомендуется выполнить перезапуск сервиса.
